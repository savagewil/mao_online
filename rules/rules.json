{
  "startup": [
    "if",
    [
      "equals",
      "start",
      "event.type"
    ],
    [
      "run_all",
      [
        "set",
        "game.turn",
        0
      ],
      [
        "set",
        "game.player_order",
        []
      ],
      [
        "add_deck",
        "Deck"
      ],
      [
        "add_deck",
        "play",
        "False",
        "True"
      ],
      [
        "deal_cards",
        "Deck",
        "play",
        1
      ],
      [
        "set",
        "game.drew",
        0
      ],
      [
        "set",
        "game.legal",
        [
          "function",
          [
            "any",
            [
              "equals",
              [
                "get_dict",
                "event.arg_1",
                "suit"
              ],
              "game.decks.play.top_card.suit"
            ],
            [
              "equals",
              [
                "get_dict",
                "event.arg_1",
                "rank"
              ],
              "game.decks.play.top_card.rank"
            ]
          ]
        ]
      ]
    ]
  ],
  "player_reg": [
    "if",
    [
      "equals",
      "player",
      "event.type"
    ],
    [
      "run_all",
      [
        "set",
        "game.player_order",
        [
          "append",
          "game.player_order",
          "event.player"
        ]
      ],
      [
        "set",
        "game",
        [
          "format",
          "add_rule.%s",
          "event.player"
        ],
        1
      ],
      [
        "draw_cards",
        "event.player",
        "Deck",
        7
      ]
    ]
  ],
  "Playing": [
    "if",
    [
      "all",
      [
        "equals",
        "chat",
        "event.type"
      ],
      [
        [
          "equals",
          "event.player",
          [
            "get_list",
            "game.player_order",
            "game.turn"
          ]
        ]
      ],
      [
        "any",
        [
          "match",
          "\\s*play\\s*\\d+\\s*",
          "event.message"
        ],
        [
          "match",
          "\\s*\\d+\\s*",
          "event.message"
        ]
      ]
    ],
    [
      "if_else",
      [
        "eval",
        "game.legal",
        [
          "get_list",
          "event.player_dict.hand",
          [
            "find",
            "\\d+",
            "event.message"
          ]
        ]
      ],
      [
        "run_all",
        [
          "play_card",
          "event.player",
          "play",
          [
            "find",
            "\\d+",
            "event.message"
          ]
        ],
        [
          "set",
          "game.turn",
          [
            "mod",
            [
              "inc",
              "game.turn"
            ],
            [
              "len",
              "game.player_order"
            ]
          ]
        ]
      ],
      [
        "run_all",
        [
          "send_chat",
          "computer",
          "That card is not legal"
        ]
      ]
    ]
  ],
  "drawing": [
    "if",
    [
      "all",
      [
        "equals",
        "chat",
        "event.type"
      ],
      [
        [
          "equals",
          "event.player",
          [
            "get_list",
            "game.player_order",
            "game.turn"
          ]
        ]
      ],
      [
        "any",
        [
          "match",
          "\\s*draw\\s*",
          "event.message"
        ],
        [
          "match",
          "\\s*d\\s*",
          "event.message"
        ]
      ]
    ],
    [
      "run_all",
      [
        "draw_cards",
        "event.player",
        "Deck",
        1
      ],
      [
        "set",
        "game.drew",
        1
      ]
    ]
  ],
  "passing": [
    "if",
    [
      "all",
      [
        "equals",
        "chat",
        "event.type"
      ],
      [
        [
          "equals",
          "event.player",
          [
            "get_list",
            "game.player_order",
            "game.turn"
          ]
        ]
      ],
      [
        "any",
        [
          "match",
          "\\s*pass\\s*",
          "event.message"
        ],
        [
          "match",
          "\\s*p\\s*",
          "event.message"
        ]
      ]
    ],
    [
      "if_else",
      "game.drew",
      [
        "run_all",
        [
          "set",
          "game.turn",
          [
            "mod",
            [
              "inc",
              "game.turn"
            ],
            [
              "len",
              "game.player_order"
            ]
          ]
        ]
      ],
      [
        "send_chat",
        "computer",
        "You must draw before passing"
      ]
    ]
  ],
  "drawing_reset": [
    "if",
    [
      "all",
      [
        "equals",
        "property_update",
        "event.type"
      ],
      [
        "equals",
        "turn",
        "event.property"
      ]
    ],
    [
      "run_all",
      [
        "set",
        "game.drew",
        0
      ]
    ]
  ],
  "winning": [
    "if",
    [
      "all",
      [
        "equals",
        "play",
        "event.type"
      ],
      [
        "not",
        "event.player_dict.hand"
      ]
    ],
    [
      "run_all",
      [
        "send_chat",
        "computer",
        [
          "format",
          "%s has won the game",
          "event.player"
        ]
      ],
      [
        "set",
        "game",
        [
          "format",
          "add_rule.%s",
          "event.player"
        ],
        [
          "inc",
          [
            "load",
            "game",
            [
              "format",
              "add_rule.%s",
              "event.player"
            ]
          ]
        ]
      ],
      [
        "draw_cards",
        "event.player",
        "Deck",
        7
      ]
    ]
  ],
  "reshuffling": [
    "if",
    [
      "all",
      [
        "equals",
        "draw",
        "event.type"
      ],
      [
        "equals",
        "Deck",
        "event.deck"
      ],
      [
        "equals",
        0,
        "event.deck_dict.card_count"
      ]
    ],
    [
      "run_all",
      [
        "send_chat",
        "computer",
        "Deck Empty"
      ],
      [
        "move_and_shuffle",
        "play",
        "Deck",
        [
          "sub",
          "game.decks.play.card_count",
          1
        ]
      ]
    ]
  ],
  "quiting": [
    "if",
    [
      "all",
      [
        "equals",
        "chat",
        "event.type"
      ],
      [
        [
          "equals",
          "event.player",
          [
            "get_list",
            "game.player_order",
            "game.turn"
          ]
        ]
      ],
      [
        "any",
        [
          "match",
          "\\s*quit\\s*",
          "event.message"
        ],
        [
          "match",
          "\\s*q\\s*",
          "event.message"
        ]
      ]
    ],
    [
      "end_game"
    ]
  ],
  "new_rule": [
    "if",
    [
      "all",
      [
        "equals",
        "chat",
        "event.type"
      ],
      [
        [
          "equals",
          "event.player",
          [
            "get_list",
            "game.player_order",
            "game.turn"
          ]
        ]
      ],
      [
        "any",
        [
          "match",
          "\\s*rule .*",
          "event.message"
        ]
      ]
    ],
    [
      "if_else",
      [
        "greater_than",
        [
          "load",
          "game",
          [
            "format",
            "add_rule.%s",
            "event.player"
          ]
        ],
        0
      ],
      [
        "run_all",
        [
          "add_rule",
          [
            "format",
            "rule_%d",
            [
              "len",
              "game.rules"
            ]
          ],
          [
            "deserialize",
            [
              "find",
              "\\s*rule (.*)",
              "event.message"
            ]
          ]
        ]
      ],
      [
        "send_chat",
        "computer",
        "You must win to make a rule"
      ]
    ]
  ]
}